<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-08-27">

<title>Dynamic Make-to-Stock Production: Producing Only What Sells – Himagineer</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-d68be38d83eca2bb035acf846ffba811.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Himagineer</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Dynamic Make-to-Stock Production: Producing Only What Sells</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Inventory Management</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 27, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="understanding-make-to-stock-production-a-dynamic-perspective" class="level2">
<h2 class="anchored" data-anchor-id="understanding-make-to-stock-production-a-dynamic-perspective">Understanding Make-to-Stock Production: A Dynamic Perspective</h2>
<p>In our ongoing exploration of dynamic inventory and production theories, we now turn our attention to <strong>Make-to-Stock (MTS) production</strong>, often referred to as “mikomi seisan” in Japanese. This approach stands in contrast to Make-to-Order (MTO) production, and a clear understanding of their distinctions is crucial for effective production management. This post will delve into the nuances of MTS, its objectives, and how a dynamic approach can optimize its effectiveness, drawing insights from tocken.com’s detailed explanation on mikomi production [1].</p>
<section id="make-to-stock-vs.-make-to-order-a-fundamental-distinction" class="level3">
<h3 class="anchored" data-anchor-id="make-to-stock-vs.-make-to-order-a-fundamental-distinction">Make-to-Stock vs.&nbsp;Make-to-Order: A Fundamental Distinction</h3>
<p>The core difference between MTO and MTS lies in the timing of production initiation relative to order confirmation. In <strong>Make-to-Order</strong>, production begins <em>after</em> a customer order is confirmed. Conversely, in <strong>Make-to-Stock</strong>, production commences <em>before</em> an order is received, based on anticipated demand. From a production management perspective, this distinction is paramount because it dictates fundamentally different management mechanisms.</p>
<p>While some might argue that their factories handle both MTO and MTS with a unified management system, this often leads to ambiguity and inefficiencies. The key is to precisely define “production start” and “order confirmation.”</p>
<ul>
<li><p><strong>Production Start:</strong> This refers to the initiation of activities to complete a specific product. It typically excludes long-term activities like factory construction or equipment installation, focusing instead on repetitive production cycles. It can range from starting design, procuring parts, or beginning assembly.</p></li>
<li><p><strong>Order Confirmation:</strong> This is when all critical aspects of a customer order are finalized. Ideally, this includes:</p>
<ol type="1">
<li>The buyer (payer) is determined.</li>
<li>Product specifications are set.</li>
<li>Delivery timing (when needed) is established.</li>
<li>Quantity to be purchased is fixed.</li>
<li>Price is agreed upon.</li>
</ol></li>
</ul>
<p>While some flexibility in these criteria might be acceptable in commercial transactions, a strict definition is essential for production management. The ambiguity often arises when companies, despite claiming to be MTO, initiate production activities based on sales forecasts rather than confirmed orders. This leads to a blend of confirmed and forecasted orders within the production plan.</p>
<p>For instance, in a factory operating on a monthly production cycle, a confirmed MTO order might only be incorporated into the production plan in the following month, leading to significant delays if lead times are short. To circumvent this, many “MTO” factories resort to informal workarounds, such as procuring materials or even starting initial production steps for unconfirmed orders, blurring the lines between MTO and MTS. This informal “make-to-forecast” within an MTO framework is a primary culprit for the ambiguity.</p>
<p>In <strong>Dynamic Production Management (DPM)</strong>, this ambiguity is eliminated. MTO strictly means production begins <em>after</em> order confirmation, and MTS means production begins <em>before</em> order confirmation. This principle is maintained without compromise. It’s also important to note that distinctions like “MTO is multi-product, small-lot; MTS is small-product, large-lot” are tendencies, not fundamental defining characteristics.</p>
</section>
<section id="the-purpose-of-make-to-stock-production" class="level3">
<h3 class="anchored" data-anchor-id="the-purpose-of-make-to-stock-production">The Purpose of Make-to-Stock Production</h3>
<p>The definition of MTS is now clear: producing before knowing who, when, or how much will be bought. This inherently carries risks of both stockouts and excess inventory, which are undesirable from a business management perspective. So, why engage in MTS production?</p>
<p>The primary objective of MTS is not merely to achieve economies of scale through planned, leveled production, as is often assumed. While mass production can reduce costs, this benefit is often negated by the risks of obsolescence and overstocking if demand is misjudged. The true purpose of MTS, from a dynamic perspective, is to <strong>produce what sells</strong> – to have the necessary products available when and where the customer needs them, <em>before</em> they place an order.</p>
<p>If production only begins after an order is confirmed, the customer might have already moved on, resulting in a lost sale. Therefore, the ultimate goal of MTS is to proactively meet customer demand. This leads us to a crucial insight: production must follow market demand. The market (customer) determines what, when, and how much is needed. Thus, the direction is clear: <strong>produce according to market demand.</strong></p>
</section>
<section id="the-mechanism-of-demand-following-make-to-stock-production" class="level3">
<h3 class="anchored" data-anchor-id="the-mechanism-of-demand-following-make-to-stock-production">The Mechanism of Demand-Following Make-to-Stock Production</h3>
<p>To achieve demand-following MTS, a dynamic system is required that can adapt to real-time market signals. This involves a shift from rigid, forecast-driven planning to a more agile, responsive approach. The website highlights the importance of a system that can quickly react to changes in demand, rather than being constrained by long planning cycles.</p>
<p>One of the key concepts introduced is the idea of a <strong>“fluid inventory”</strong> or <strong>“inventory flow management”</strong> system, which we discussed in a previous post. In the context of MTS, this means managing inventory not as static quantities, but as dynamic flows that respond to actual consumption. The system needs to be able to:</p>
<ol type="1">
<li><strong>Monitor Real-time Demand:</strong> Continuously track sales and consumption data to understand actual market off-take.</li>
<li><strong>Adjust Production Rates Dynamically:</strong> Based on real-time demand, adjust production output to match consumption, preventing both stockouts and overproduction.</li>
<li><strong>Maintain Optimal Inventory Levels:</strong> Instead of fixed “safety stocks,” the system aims to maintain a fluid inventory level that minimizes holding costs while ensuring product availability.</li>
</ol>
<p>This dynamic adjustment is crucial. If demand increases, the system should automatically trigger an increase in production. If demand drops, production should be scaled back. This responsiveness is what differentiates dynamic MTS from traditional, forecast-driven MTS.</p>
</section>
<section id="replenishing-inventory-from-the-production-line" class="level3">
<h3 class="anchored" data-anchor-id="replenishing-inventory-from-the-production-line">Replenishing Inventory from the Production Line</h3>
<p>In a dynamic MTS system, the production line is directly linked to inventory replenishment. Instead of producing to a fixed schedule and then pushing products into a warehouse, the production line pulls demand from the inventory. This means that as products are sold and inventory levels drop, a signal is sent back to the production line to replenish those specific items. This is a pull-based system, in contrast to a push-based system.</p>
<p>Consider a simplified model of this replenishment process:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    A[Customer Demand] --&gt; B{Inventory Level}
    B -- Below Threshold --&gt; C[Production Trigger]
    C --&gt; D[Production Line]
    D --&gt; E[Finished Goods Inventory]
    E --&gt; B
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>This diagram illustrates a basic feedback loop. When customer demand reduces the inventory level below a certain threshold, it triggers the production line to replenish the stock. This continuous feedback ensures that production is always aligned with actual consumption.</p>
</section>
<section id="adjusting-production-capacity-and-input-restrictions" class="level3">
<h3 class="anchored" data-anchor-id="adjusting-production-capacity-and-input-restrictions">Adjusting Production Capacity and Input Restrictions</h3>
<p>Dynamic MTS also requires flexible production capacity and intelligent input restrictions. Production capacity needs to be adaptable to fluctuations in demand. This might involve:</p>
<ul>
<li><strong>Flexible Workforce:</strong> Cross-training employees or utilizing temporary staff to adjust labor capacity.</li>
<li><strong>Modular Production Lines:</strong> Designing production lines that can be easily reconfigured or scaled up/down.</li>
<li><strong>Strategic Outsourcing:</strong> Leveraging external partners for overflow production during peak demand.</li>
</ul>
<p>Furthermore, input restrictions are critical to prevent overproduction and excessive Work-In-Process (WIP). This is where the concept of a <strong>“WIP cap”</strong> or <strong>“input limit”</strong> becomes important. By setting a maximum limit on the amount of WIP in the system, it prevents the production line from producing more than what the downstream processes or customer demand can absorb. This helps to maintain a smooth flow and prevent bottlenecks.</p>
</section>
<section id="customer-lead-time-considerations" class="level3">
<h3 class="anchored" data-anchor-id="customer-lead-time-considerations">Customer Lead Time Considerations</h3>
<p>When customer lead time (the time between order placement and delivery) is a factor, the dynamic MTS system needs to account for it. If the lead time is significant, the system must anticipate future demand further in advance. This can be incorporated into the replenishment trigger, where the threshold for triggering production is adjusted based on the lead time. For example, if the lead time is ‘L’ days, the system might trigger production when the inventory level is sufficient to cover ‘L’ days of anticipated demand.</p>
</section>
<section id="dynamic-make-to-stock-production-introducing-the-s-unit" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-make-to-stock-production-introducing-the-s-unit">Dynamic Make-to-Stock Production: Introducing the S-Unit</h3>
<p>The website introduces the concept of an <strong>S-Unit</strong> as a core component of dynamic make-to-stock production. While the details are not fully elaborated on the page, the S-Unit appears to be a standardized unit or module that facilitates flexible and responsive production. It likely represents a smallest common denominator in terms of production or inventory, allowing for granular control and rapid adjustments.</p>
<p>Without explicit equations on the website, we can infer some fundamental relationships that govern dynamic MTS. Let’s consider the basic inventory balance equation:</p>
<p><span class="math display">\[I_{t} = I_{t-1} + P_{t} - D_{t}\]</span></p>
<p>Where: * <span class="math inline">\(I_{t}\)</span> = Inventory at the end of period <span class="math inline">\(t\)</span> * <span class="math inline">\(I_{t-1}\)</span> = Inventory at the end of period <span class="math inline">\(t-1\)</span> * <span class="math inline">\(P_{t}\)</span> = Production in period <span class="math inline">\(t\)</span> * <span class="math inline">\(D_{t}\)</span> = Demand in period <span class="math inline">\(t\)</span></p>
<p>In a dynamic MTS system, the goal is to keep <span class="math inline">\(I_t\)</span> within a desired range. This means <span class="math inline">\(P_t\)</span> needs to be responsive to <span class="math inline">\(D_t\)</span>. A simple control rule could be:</p>
<p><span class="math display">\[P_{t} = D_{t} + k(I_{target} - I_{t-1})\]</span></p>
<p>Where: * <span class="math inline">\(I_{target}\)</span> = Desired target inventory level * <span class="math inline">\(k\)</span> = A control parameter (e.g., a fraction of the inventory deviation to correct in the next period)</p>
<p>This equation suggests that production in period <span class="math inline">\(t\)</span> is driven by current demand (<span class="math inline">\(D_t\)</span>) and an adjustment based on the deviation of the previous period’s inventory (<span class="math inline">\(I_{t-1}\)</span>) from the target inventory (<span class="math inline">\(I_{target}\)</span>). The parameter <span class="math inline">\(k\)</span> would determine how aggressively the system tries to correct inventory deviations. A higher <span class="math inline">\(k\)</span> would lead to faster adjustments but could also introduce instability.</p>
<p>For the WIP cap, we can define:</p>
<p><span class="math display">\[WIP_{t} \le WIP_{max}\]</span></p>
<p>Where: * <span class="math inline">\(WIP_{t}\)</span> = Work-in-process at the end of period <span class="math inline">\(t\)</span> * <span class="math inline">\(WIP_{max}\)</span> = Maximum allowable work-in-process</p>
<p>This constraint would directly influence the production trigger, ensuring that new production is only initiated if the WIP level is below the maximum. This helps to prevent bottlenecks and maintain flow.</p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>Dynamic Make-to-Stock production represents a significant evolution from traditional MTS, moving away from rigid, forecast-driven planning towards a highly responsive, demand-following system. By embracing real-time data, flexible capacity, and intelligent input restrictions, businesses can achieve a more agile and efficient production process that minimizes both stockouts and excess inventory. The underlying principle is to produce only what sells, driven by actual market demand rather than speculative forecasts.</p>
<p>This approach aligns with the broader principles of Dynamic Production Management and the ongoing digital transformation in manufacturing. In the next post, we will explore further practical applications and advanced concepts related to these dynamic systems.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/okihik\.github\.io\/versatile-note\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>