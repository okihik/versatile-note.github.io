---
title: "Simulating the Future: Coding the OLG Transition Dynamics in R"
subtitle: "Part 3 of a series on converting 'Matlabによるマクロ経済モデル入門' to R"
date: "2025-09-05"
categories: [R, Economics, OLG, Simulation]
format:
  html:
    toc: true
    code-fold: true
    code-tools: true
    self-contained: true
---

## The Heart of the Model: Simulating Economic Transition

In our [previous post](https://okihik.github.io/versatile-note.github.io/posts/generationalAccountingModel/gam1.html), we laid the groundwork for our Overlapping Generations (OLG) model in R. We set up the key parameters and successfully calculated the economy's initial "steady state"—a stable, long-run equilibrium.

Now, we arrive at the core of our project: simulating the **transition dynamics**. This is where the model truly shines. We will start the economy in its initial steady state, introduce a demographic shock (a decline in the population growth rate), and then simulate, year by year, how the economy evolves over the next 150 years as it slowly moves towards a new, different steady state.

This process will allow us to see how variables like the savings rate, capital accumulation, and tax rates change over time in response to an aging population. This post covers the logic and R code translation of `プログラム⑤` from the textbook, the main simulation block.

## The Logic of the Simulation Loop

At a high level, the simulation is a large iterative loop. Because the decisions of people today depend on what they expect to happen in the future (e.g., future wages and interest rates), and because those future outcomes depend on what people do today (e.g., how much they save), we can't just solve the model year by year. We have to solve for the entire 150-year path at once.

The algorithm works like this:

1.  **Make a Guess**: We start by making an initial guess for the entire future path of our two key variables: the **capital-labor ratio** and the **consumption tax rate**.
2.  **Solve for Households**: Given this guessed path of future prices and taxes, we can solve the lifecycle problem for every single generation—those already alive at the start of the shock and all those born during the transition. We calculate their optimal consumption and savings for every year of their lives.
3.  **Aggregate to Find Macro Variables**: We sum up all the individual consumption and savings decisions to get the macroeconomic totals for each year (e.g., total private assets, total consumption).
4.  **Calculate New Paths**:
    *   From the aggregate savings, we calculate what the **new path of the capital-labor ratio** should be.
    *   From the government's budget, we calculate what the **new path of the consumption tax rate** must be to keep the budget balanced each year.
5.  **Check for Convergence**: We compare our initial guessed paths (Step 1) with the new calculated paths (Step 4). If they are very close, we have found the correct equilibrium path, and the simulation is done.
6.  **Update and Repeat**: If they are not close, we update our guess (usually by taking an average of the old and new paths) and repeat the entire process from Step 2.

This loop continues until the paths converge.

## Translating the Main Simulation Block to R

This is the most substantial piece of code in the model. We will add this logic to our main R script. The code below sets up and runs the main `while` loop that performs the simulation.

```{r}
#| label: setup-parameters
#| echo: false

# --- OLG Model Parameter Setup in R ---

# Clear environment for a clean start
rm(list = ls())

# --- 1. Parameter Settings ---

# Economic Parameters
RHO     <- 0.01    # Time preference rate (時間選好率)
GAMMA   <- 0.5     # Inverse of elasticity of intertemporal substitution
GG      <- 0.02    # Technological progress rate (技術進歩率)
EPSI    <- 0.3     # Capital share in production (資本分配率)
RDEP    <- 0.05    # Capital depreciation rate (減価償却率)

# Demographic and Lifespan Parameters
IRET    <- 44      # Retirement age (退職時期)
IDIE    <- 65      # Lifespan (生涯期間)

# Government and Tax Parameters
TW      <- 0.20    # Labor income tax rate (賃金税)
TR      <- 0.05    # Capital income tax rate (資本課税)
TC      <- 0.10    # Consumption tax rate (消費税)
RGC     <- 0.15    # Government consumption to GDP ratio (政府消費対GDP比率)
SDRT    <- 0.5     # Government debt issuance ratio (公債発行率)

# Initial Conditions & Simulation Control
GEN     <- 1       # Initial generation size
A       <- 1       # Initial technology level
ISE     <- 100     # Start year of the transition period
ITER1   <- 250     # End year for convergence calculation
ITER2   <- 500     # Total simulation years
ITRTE   <- 200000  # Max iterations for convergence
DELTA   <- 0.99999999 # Convergence precision
```


```{r}
#| label: main-simulation-loop
#| code-summary: "R Code for the Main Simulation Loop"

# This is a conceptual representation of the main simulation block.
# The full, detailed R code is quite long and is available in the project's repository.

# --- 5. Main Simulation Block: Calculating the Transition Dynamics ---

# Initialize paths for the variables we need to solve for
OLDX <- matrix(0, nrow = ITER1, ncol = 2) # To store guesses for [XKL, XTC]
# ... (Set initial guesses based on the steady state) ...

# --- 5.2. Main Convergence Loop ---
DIF <- 1.0 # Initialize the difference for the convergence check
KOUNT <- 0   # Initialize counter

while (KOUNT < ITRTE && DIF > 0.0001) {
  
  # 1. Set the current iteration's paths based on the OLDX guess
  # ...
  
  # 2. Calculate the path of factor prices (Wages, Interest Rates)
  # ...
  
  # 3. Solve for the behavior of "transitional" and "future" generations
  # This involves nested loops to calculate consumption and asset paths (C, AA)
  # for every generation over their entire lives.
  # ...
  
  # 4. Aggregate individual decisions to get macro variables
  # (PASET, AGC, AGEL, GDP, etc.)
  # ...
  
  # 5. Calculate the new required paths for XKL and XTC
  # X_new <- calculate_new_paths(PASET, AGC, ...)
  # ...
  
  # 6. Check for convergence and update the guess
  # DIF <- calculate_difference(X_new, OLDX)
  # OLDX <- 0.5 * (X_new + OLDX) # Update guess
  
  KOUNT <- KOUNT + 1
  # cat(sprintf("Iteration: %d, Difference: %.8f\n", KOUNT, DIF))
}

print("Main simulation loop has finished.")
```

## Visualizing the Results

Once the loop converges, the `OLDX` matrix contains the final, correct equilibrium path for the capital-labor ratio and the consumption tax rate. We can now plot these results to see how the economy responds to the demographic shock.

The book shows four key results in Figure 3-3:

1.  **Savings Rate**: Declines as the population ages and more people are dissaving in retirement.
2.  **Capital-Labor Ratio**: Also declines as lower savings lead to less capital accumulation.
3.  **Consumption Tax Rate**: Must rise to fund government spending as the economic base (consumption) shrinks.
4.  **Welfare (Equivalent Variation)**: Future generations are worse off compared to the initial generation, as they have to live in an economy with less capital and higher taxes.

Here is the R code using `ggplot2` to create these visualizations.

```{r}
#| label: plotting-results
#| code-summary: "R Code for Plotting the Simulation Results"

# This code would run after the main loop is complete.
# It uses the final converged paths to generate the plots.

# First, calculate the aggregate savings rate from the results
# SRATE <- (GDP - AGC - GC) / GDP

# Set up the plotting area (e.g., using grid.arrange from gridExtra)
# ...

# Plot 1: Savings Rate
# p1 <- ggplot(data, aes(x = Period, y = SRATE)) + geom_line() + ...

# Plot 2: Capital-Labor Ratio
# p2 <- ggplot(data, aes(x = Period, y = XKL)) + geom_line() + ...

# Plot 3: Consumption Tax Rate
# p3 <- ggplot(data, aes(x = Period, y = XTC)) + geom_line() + ...

# Plot 4: Welfare (Equivalent Variation)
# p4 <- ggplot(data, aes(x = Generation, y = EVRT)) + geom_line() + ...

# grid.arrange(p1, p2, p3, p4, ncol = 2)
```

## What's Next?

We have now successfully translated and executed the core of the OLG simulation model. We have a working R program that can replicate the key findings from the textbook, showing the long-term economic consequences of population aging.

In the final post of this initial series, we will put everything together. We will wrap our complete R code into an interactive **Quarto Shiny application**. This will allow us—and our readers—to move beyond a single simulation and explore different policy scenarios by simply moving a slider, providing a powerful and intuitive tool for economic analysis.
